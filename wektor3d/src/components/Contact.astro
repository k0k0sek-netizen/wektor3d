---
---

<section class="py-24 bg-zinc-900 text-white fade-in-section" id="kontakt">
  <div class="container mx-auto px-4 max-w-2xl">
    <div class="text-center mb-12">
      <h2 class="text-3xl md:text-5xl bg-clip-text text-transparent bg-gradient-to-b from-white via-zinc-200 to-zinc-500 font-bold tracking-tight mb-4">Skonsultuj swój projekt</h2>
      <p class="text-zinc-300 text-lg">Wypełnij formularz, a odpowiem z wyceną najszybciej jak to możliwe.</p>
      <p class="text-sm text-zinc-400 mt-4 flex items-center justify-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
        </svg>
        Odpowiadam zazwyczaj w ciągu 2 godzin. Wstępna analiza wykonalności jest zawsze darmowa.
      </p>
    </div>

    <form id="contact-form" action="https://formspree.io/f/mjkzrlay" class="space-y-6 bg-zinc-950/50 p-8 rounded-2xl border border-zinc-800 shadow-xl">
      
      <!-- Hidden Subject -->
      <input type="hidden" name="_subject" value="Nowy Lead Wektor 3D" />
      
      <!-- Name -->
      <div>
        <label for="name" class="block text-sm font-medium text-zinc-300 mb-2">Imię</label>
        <input 
          type="text" 
          id="name" 
          name="name" 
          name="name"
          class="w-full bg-zinc-950 border border-zinc-800 rounded-lg px-4 py-3 text-white placeholder:text-zinc-500 focus:outline-none focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-colors"
        />
      </div>

      <!-- Email -->
      <div>
        <label for="email" class="block text-sm font-medium text-zinc-300 mb-2">Email</label>
        <input 
          type="email" 
          id="email" 
          name="email" 
          name="email"
          class="w-full bg-zinc-950 border border-zinc-800 rounded-lg px-4 py-3 text-white placeholder:text-zinc-500 focus:outline-none focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-colors"
        />
      </div>

      <!-- Order Type -->
      <div>
        <label for="service-type" class="block text-sm font-medium text-zinc-300 mb-2">Rodzaj zgłoszenia</label>
        <select 
          id="service-type" 
          name="service" 
          class="w-full bg-zinc-950 border border-zinc-800 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-colors appearance-none"
        >
          <option value="print">Mam gotowy plik do druku</option>
          <option value="link">Posiadam link do modelu</option>
          <option value="reverse">Zlecenie inżynierii odwrotnej</option>
          <option value="other">Inne / Oprzyrządowanie</option>
        </select>
      </div>

      <!-- Link to Model -->
      <div>
        <label for="model-link" class="block text-sm font-medium text-zinc-300 mb-2">Link do modelu</label>
        <input 
          type="text" 
          id="model-link" 
          name="link" 
          name="link"
          placeholder="Link do pliku (np. Google Drive, WeTransfer, Dropbox)"
          class="w-full bg-zinc-950 border border-zinc-800 rounded-lg px-4 py-3 text-white placeholder:text-zinc-500 focus:outline-none focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-colors"
        />
      </div>

      <!-- Material -->
      <div>
        <label for="contact-material" class="block text-sm font-medium text-zinc-300 mb-2">Materiał</label>
        <select 
          id="contact-material" 
          name="material" 
          class="w-full bg-zinc-950 border border-zinc-800 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-colors appearance-none"
        >
          <option value="doradz">Nie wiem / Doradź mi</option>
          <option value="pla">PLA</option>
          <option value="petg">PETG</option>
          <option value="asa">ASA</option>
          <option value="tpu">TPU</option>
        </select>
      </div>

      <!-- Message -->
      <div>
        <label for="message" class="block text-sm font-medium text-zinc-300 mb-2">Wiadomość (opcjonalne)</label>
        <textarea 
          id="message" 
          name="message" 
          rows="4"
          class="w-full bg-zinc-950 border border-zinc-800 rounded-lg px-4 py-3 text-white placeholder:text-zinc-500 focus:outline-none focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition-colors resize-none"
        ></textarea>
      </div>

      <!-- Submit Button -->
      <button 
        type="submit" 
        class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-4 rounded-lg transition-colors shadow-lg shadow-orange-900/20"
      >
        Wyślij Zapytanie
      </button>

    </form>
  </div>
  </div>
</section>

<script>
  import { contactFormSchema } from '../lib/contactSchema';

  // Funkcja inicjalizująca formularz (musi być wywoływana przy każdym załadowaniu strony)
  function initContactForm() {
    const form = document.getElementById('contact-form');
    const serviceSelect = document.getElementById('service-type');
    const linkInput = document.getElementById('model-link');

    // 1. Logika wymagalności pola Link (UX only - walidacja jest w Zod)
    function toggleLinkRequirement() {
      if (!serviceSelect || !linkInput) return;

      const selected = serviceSelect.value;
      const needsLink = ['print', 'link'].includes(selected);

      if (needsLink) {
        // Dodajemy wizualny wskaźnik, ale walidację zostawiamy Zodowi (lub HTML5 dla prostoty)
        linkInput.placeholder = 'Link do pliku .stl/.3mf (wymagane)...';
        linkInput.classList.add('ring-1', 'ring-orange-500/50');
      } else {
        linkInput.placeholder = 'Link do zdjęć lub opis (opcjonalne)...';
        linkInput.classList.remove('ring-1', 'ring-orange-500/50');
      }
    }

    // 2. Obsługa wysyłania (Zod Validation + AJAX)
    async function handleSubmit(e) {
      e.preventDefault(); 
      
      const submitBtn = form.querySelector('button[type="submit"]');
      const originalBtnText = submitBtn.innerText;

      // Pobierz dane z formularza
      const formData = new FormData(form);
      const rawData = Object.fromEntries(formData.entries());

      // WALIDACJA ZOD
      const result = contactFormSchema.safeParse(rawData);

      if (!result.success) {
        // Formatowanie błędów
        const errorMessages = result.error.issues.map(issue => issue.message).join('\n');
        alert(`Błąd walidacji:\n${errorMessages}`);
        return; // STOP
      }

      // Jeśli walidacja przeszła, wysyłamy
      submitBtn.innerText = 'Wysyłanie...';
      submitBtn.disabled = true;

      const action = form.getAttribute('action'); 

      try {
        const response = await fetch(action, {
          method: 'POST',
          body: formData, // Wysyłamy oryginalne FormData do Formspree
          headers: {
            'Accept': 'application/json'
          }
        });

        if (response.ok) {
          form.reset(); 
          toggleLinkRequirement(); 
          window.location.href = '/dziekuje'; 
        } else {
          const data = await response.json();
          if (Object.hasOwn(data, 'errors')) {
            alert('Błąd: ' + data["errors"].map(error => error["message"]).join(", "));
          } else {
            alert('Wystąpił problem z wysłaniem formularza.');
          }
          submitBtn.innerText = originalBtnText;
          submitBtn.disabled = false;
        }
      } catch (error) {
        console.error('Błąd wysyłania:', error);
        alert('Wystąpił błąd połączenia. Spróbuj ponownie.');
        submitBtn.innerText = originalBtnText;
        submitBtn.disabled = false;
      }
    }

    // Podpięcie zdarzeń
    if (serviceSelect) {
      serviceSelect.removeEventListener('change', toggleLinkRequirement);
      serviceSelect.addEventListener('change', toggleLinkRequirement);
      toggleLinkRequirement();
    }

    if (form) {
      form.removeEventListener('submit', handleSubmit);
      form.addEventListener('submit', handleSubmit);
    }
  }

  // OBSŁUGA ASTRO VIEW TRANSITIONS
  initContactForm();
  document.addEventListener('astro:page-load', initContactForm);
</script>
